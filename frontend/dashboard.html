<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="dashboard.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<script>
  // Verifica se está logado
  const token = localStorage.getItem("token");
  if (!token) {
    window.location.href = "login.html";
  }
</script>
<header class="navbar">
  <div class="container nav-content">
    <div>
      <h2>Admin Dashboard</h2>
      <span class="muted">admin@portfolio.com</span>
    </div>
    <div class="nav-buttons">
      <a href="index.html" class="btn ghost">Ver portfólio</a>
      <button class="btn outline">Sair</button>
    </div>
  </div>
</header>

<main class="container">

  <div class="header-row">
    <div>
      <h1>Meus Projetos</h1>
      <p class="muted" id="contadorProjetos">Carregando...</p>
    </div>
    <a href="novo-projeto.html" class="btn primary">Novo Projeto</a>
  </div>

  <div class="table" id="projectsTable">
    <!-- Projetos serão carregados via JS -->
  </div>
</main>

<!-- MODAL EDIT -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <h3>Editar Projeto</h3>
    <label>Nome</label>
    <input type="text" id="editNome">
    <label>Descrição</label>
    <textarea id="editDescricao"></textarea>
    <label>URL da Imagem</label>
    <input type="text" id="editFoto">
    <div class="modal-actions">
      <button class="btn outline" onclick="closeModal()">Cancelar</button>
      <button class="btn primary" onclick="salvarEdicao()">Salvar</button>
    </div>
  </div>
</div>

<!-- MODAL DELETE -->
<div class="modal" id="deleteModal">
  <div class="modal-content">
    <h3>Confirmar Exclusão</h3>
    <p id="deleteText"></p>
    <div class="modal-actions">
      <button class="btn outline" onclick="closeModal()">Cancelar</button>
      <button class="btn danger" onclick="confirmarExclusao()">Excluir</button>
    </div>
  </div>
</div>


<script>
  lucide.createIcons();

  async function carregarProjetos() {
    const token = localStorage.getItem("token");
    try {
      const res = await fetch("http://localhost:3000/projetos", {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const projetos = await res.json();
      const table = document.getElementById("projectsTable");
      table.innerHTML = "";
      // Atualiza contador de projetos
      document.getElementById("contadorProjetos").innerText = `${projetos.length} projetos cadastrados`;
      if (Array.isArray(projetos) && projetos.length > 0) {
        projetos.forEach(proj => {
          table.innerHTML += `
            <div class='row'>
              <div>
                <h3>${proj.nome || "Sem título"}</h3>
                <p class='muted'>${proj.descricao || "Sem descrição"}</p>
              </div>
              <div>
                <a href='${proj.foto || "#"}' target='_blank'>${proj.foto ? "Ver imagem" : "Sem imagem"}</a>
              </div>
              <div class='actions'>
                <button class='icon-btn' onclick='openEdit(${JSON.stringify(proj)})'><i data-lucide="pencil"></i></button>
                <button class='icon-btn danger' onclick='openDelete("${proj.id}", "${proj.nome}")'><i data-lucide="trash-2"></i></button>
              </div>
            </div>
          `;
        });
      } else {
        table.innerHTML = "<div class='row'><div><h3>Nenhum projeto cadastrado</h3></div></div>";
        document.getElementById("contadorProjetos").innerText = "0 projetos cadastrados";
      }
      lucide.createIcons();
    } catch (e) {
      document.getElementById("projectsTable").innerHTML = "<div class='row'><div><h3>Erro ao carregar projetos</h3></div></div>";
      document.getElementById("contadorProjetos").innerText = "Erro ao carregar";
    }
  }
  // Botão Sair
  document.addEventListener("DOMContentLoaded", function() {
    const btnSair = document.querySelector(".btn.outline");
    if (btnSair) {
      btnSair.addEventListener("click", function() {
        localStorage.removeItem("token");
        window.location.href = "login.html";
      });
    }
  });

  // Modal edição
  let projetoEditando = null;
  function openEdit(proj) {
    projetoEditando = proj;
    document.getElementById("editNome").value = proj.nome || "";
    document.getElementById("editDescricao").value = proj.descricao || "";
    document.getElementById("editFoto").value = proj.foto || "";
    document.getElementById("editModal").style.display = "flex";
  }

  async function salvarEdicao() {
    if (!projetoEditando) return;
    const token = localStorage.getItem("token");
    const id = projetoEditando.id;
    const dados = {
      nome: document.getElementById("editNome").value,
      descricao: document.getElementById("editDescricao").value,
      foto: document.getElementById("editFoto").value
    };
    try {
      const res = await fetch(`http://localhost:3000/projetos/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(dados)
      });
      if (res.ok) {
        closeModal();
        carregarProjetos();
      } else {
        alert("Erro ao editar projeto.");
      }
    } catch {
      alert("Erro ao conectar com a API.");
    }
  }

  // Modal exclusão
  let projetoExcluindoId = null;
  function openDelete(id, nome) {
    projetoExcluindoId = id;
    document.getElementById("deleteText").innerText =
      `Tem certeza que deseja excluir \"${nome}\"?`;
    document.getElementById("deleteModal").style.display = "flex";
  }

  async function confirmarExclusao() {
    if (!projetoExcluindoId) return;
    const token = localStorage.getItem("token");
    try {
      const res = await fetch(`http://localhost:3000/projetos/${projetoExcluindoId}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (res.ok) {
        closeModal();
        carregarProjetos();
      } else {
        alert("Erro ao excluir projeto.");
      }
    } catch {
      alert("Erro ao conectar com a API.");
    }
  }

  function closeModal() {
    document.getElementById("editModal").style.display = "none";
    document.getElementById("deleteModal").style.display = "none";
    projetoEditando = null;
    projetoExcluindoId = null;
  }

  window.onload = carregarProjetos;
</script>

</body>
</html>